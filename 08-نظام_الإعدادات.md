# نظام الإعدادات

## 🎯 نظرة عامة

نظام الإعدادات هو المسؤول عن إدارة وتخصيص مختلف جوانب النادي الرياضي. يتيح هذا النظام للمديرين والمسؤولين تكوين النظام وفقًا لاحتياجات النادي الخاصة، وتعديل الإعدادات العامة، وإدارة المستخدمين والصلاحيات، وتخصيص واجهة المستخدم، وإدارة إعدادات النظام المختلفة.

## 📋 الوظائف الرئيسية

### 1. إعدادات النادي
- تعديل معلومات النادي (الاسم، العنوان، معلومات الاتصال)
- تحميل شعار النادي
- تعديل ساعات العمل
- تكوين العملة والمنطقة الزمنية

### 2. إدارة المستخدمين والصلاحيات
- إضافة مستخدمين جدد
- تعديل بيانات المستخدمين
- تعيين الأدوار والصلاحيات
- إدارة كلمات المرور وسياسات الأمان

### 3. تخصيص واجهة المستخدم
- تغيير السمة والألوان
- تخصيص لوحة المعلومات
- تكوين الإشعارات والتنبيهات
- تخصيص التقارير والقوائم

### 4. إعدادات النظام
- تكوين النسخ الاحتياطي
- إعدادات البريد الإلكتروني والرسائل القصيرة
- إعدادات الطباعة
- إعدادات الاتصال بالأجهزة الخارجية

## 🗃️ نماذج البيانات

### نموذج إعدادات النادي (GymSettings)

```python
class GymSettings(db.Model):
    __tablename__ = 'gym_settings'
    
    id = db.Column(db.Integer, primary_key=True)
    gym_name = db.Column(db.String(100), nullable=False)
    gym_address = db.Column(db.Text)
    gym_phone = db.Column(db.String(20))
    gym_email = db.Column(db.String(100))
    gym_logo_path = db.Column(db.String(255))
    currency = db.Column(db.String(10), default='EGP')
    timezone = db.Column(db.String(50), default='Africa/Cairo')
    opening_time = db.Column(db.Time, default=time(6, 0))  # 6:00 AM
    closing_time = db.Column(db.Time, default=time(23, 0))  # 11:00 PM
    tax_rate = db.Column(db.Float, default=0)
    enable_sms = db.Column(db.Boolean, default=False)
    enable_email = db.Column(db.Boolean, default=False)
    enable_notifications = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def __repr__(self):
        return f'<GymSettings {self.gym_name}>'
    
    @classmethod
    def get_settings(cls):
        """الحصول على إعدادات النادي"""
        settings = cls.query.first()
        if not settings:
            # إنشاء إعدادات افتراضية إذا لم تكن موجودة
            settings = cls(
                gym_name="Gymawy",
                gym_address="123 Main St, Cairo, Egypt",
                gym_phone="+201234567890",
                gym_email="info@gymawy.com"
            )
            db.session.add(settings)
            db.session.commit()
        return settings
```

### نموذج المستخدم (User)

```python
class User(db.Model, UserMixin):
    __tablename__ = 'users'
    
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    email = db.Column(db.String(100), unique=True, nullable=False)
    password_hash = db.Column(db.String(128))
    first_name = db.Column(db.String(50))
    last_name = db.Column(db.String(50))
    role_id = db.Column(db.Integer, db.ForeignKey('roles.id'))
    active = db.Column(db.Boolean, default=True)
    last_login = db.Column(db.DateTime)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # العلاقات
    role = db.relationship('Role', backref='users')
    
    def __repr__(self):
        return f'<User {self.username}>'
    
    def set_password(self, password):
        """تعيين كلمة المرور المشفرة"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """التحقق من كلمة المرور"""
        return check_password_hash(self.password_hash, password)
    
    def has_permission(self, permission):
        """التحقق من صلاحية المستخدم"""
        if not self.role:
            return False
        return self.role.has_permission(permission)
```

### نموذج الدور (Role)

```python
class Role(db.Model):
    __tablename__ = 'roles'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True, nullable=False)
    description = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # العلاقات
    permissions = db.relationship('Permission', secondary='role_permissions', backref='roles')
    
    def __repr__(self):
        return f'<Role {self.name}>'
    
    def has_permission(self, permission_name):
        """التحقق من وجود الصلاحية"""
        for permission in self.permissions:
            if permission.name == permission_name:
                return True
        return False
```

### نموذج الصلاحية (Permission)

```python
class Permission(db.Model):
    __tablename__ = 'permissions'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True, nullable=False)
    description = db.Column(db.Text)
    module = db.Column(db.String(50))  # المديول أو القسم الذي تنتمي إليه الصلاحية
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def __repr__(self):
        return f'<Permission {self.name}>'
```

### جدول العلاقة بين الأدوار والصلاحيات (RolePermission)

```python
role_permissions = db.Table('role_permissions',
    db.Column('role_id', db.Integer, db.ForeignKey('roles.id'), primary_key=True),
    db.Column('permission_id', db.Integer, db.ForeignKey('permissions.id'), primary_key=True)
)
```

### نموذج تخصيص واجهة المستخدم (UISettings)

```python
class UISettings(db.Model):
    __tablename__ = 'ui_settings'
    
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    theme = db.Column(db.String(20), default='light')  # light, dark
    primary_color = db.Column(db.String(20), default='blue')
    sidebar_collapsed = db.Column(db.Boolean, default=False)
    dashboard_widgets = db.Column(db.Text)  # JSON string of widget configuration
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # العلاقات
    user = db.relationship('User', backref='ui_settings')
    
    def __repr__(self):
        return f'<UISettings for {self.user.username}>'
```

## 🔄 العلاقات مع الأنظمة الأخرى

### 1. العلاقة مع جميع الأنظمة
- توفير الإعدادات العامة لجميع الأنظمة
- التحكم في سلوك الأنظمة المختلفة
- توفير معلومات النادي لجميع الأنظمة

### 2. العلاقة مع نظام المستخدمين
- إدارة حسابات المستخدمين
- تحديد الأدوار والصلاحيات
- التحكم في الوصول إلى الأنظمة المختلفة

### 3. العلاقة مع نظام التقارير
- تكوين التقارير وتخصيصها
- تحديد التقارير المتاحة لكل دور
- تحديد جدولة التقارير

## 🖥️ واجهات المستخدم

### 1. صفحة إعدادات النادي
- نموذج لتعديل معلومات النادي
- تحميل شعار النادي
- تعديل ساعات العمل
- تكوين العملة والمنطقة الزمنية

### 2. صفحة إدارة المستخدمين
- قائمة بجميع المستخدمين
- إضافة/تعديل/حذف المستخدمين
- تعيين الأدوار والصلاحيات

### 3. صفحة الأدوار والصلاحيات
- قائمة بجميع الأدوار
- إضافة/تعديل/حذف الأدوار
- تعيين الصلاحيات لكل دور

### 4. صفحة تخصيص واجهة المستخدم
- تغيير السمة والألوان
- تخصيص لوحة المعلومات
- تكوين الإشعارات والتنبيهات

### 5. صفحة إعدادات النظام
- تكوين النسخ الاحتياطي
- إعدادات البريد الإلكتروني والرسائل القصيرة
- إعدادات الطباعة
- إعدادات الاتصال بالأجهزة الخارجية

## 🛠️ الخدمات والوظائف المتقدمة

### 1. إدارة إعدادات النادي

```python
def update_gym_settings(**kwargs):
    """تحديث إعدادات النادي"""
    settings = GymSettings.get_settings()
    
    for key, value in kwargs.items():
        if hasattr(settings, key):
            setattr(settings, key, value)
    
    settings.updated_at = datetime.utcnow()
    db.session.commit()
    
    return settings

def upload_gym_logo(logo_file):
    """تحميل شعار النادي"""
    if not logo_file:
        return None
    
    # التحقق من نوع الملف
    if not allowed_file(logo_file.filename, ['png', 'jpg', 'jpeg', 'svg']):
        raise ValueError("File type not allowed")
    
    # حفظ الملف
    filename = secure_filename(logo_file.filename)
    timestamp = int(time.time())
    new_filename = f"logo_{timestamp}_{filename}"
    file_path = os.path.join(current_app.config['UPLOAD_FOLDER'], 'logos', new_filename)
    
    # التأكد من وجود المجلد
    os.makedirs(os.path.dirname(file_path), exist_ok=True)
    
    # حفظ الملف
    logo_file.save(file_path)
    
    # تحديث مسار الشعار في الإعدادات
    relative_path = os.path.join('uploads', 'logos', new_filename)
    settings = GymSettings.get_settings()
    settings.gym_logo_path = relative_path
    db.session.commit()
    
    return relative_path
```

### 2. إدارة المستخدمين والأدوار

```python
def create_user(username, email, password, first_name, last_name, role_id):
    """إنشاء مستخدم جديد"""
    # التحقق من عدم وجود مستخدم بنفس اسم المستخدم أو البريد الإلكتروني
    existing_user = User.query.filter(
        (User.username == username) | (User.email == email)
    ).first()
    
    if existing_user:
        if existing_user.username == username:
            raise ValueError("Username already exists")
        else:
            raise ValueError("Email already exists")
    
    # إنشاء المستخدم الجديد
    user = User(
        username=username,
        email=email,
        first_name=first_name,
        last_name=last_name,
        role_id=role_id
    )
    
    user.set_password(password)
    
    db.session.add(user)
    db.session.commit()
    
    return user

def update_user(user_id, **kwargs):
    """تحديث بيانات المستخدم"""
    user = User.query.get(user_id)
    if not user:
        raise ValueError("User not found")
    
    # التحقق من تغيير اسم المستخدم أو البريد الإلكتروني
    if 'username' in kwargs and kwargs['username'] != user.username:
        existing_user = User.query.filter_by(username=kwargs['username']).first()
        if existing_user:
            raise ValueError("Username already exists")
    
    if 'email' in kwargs and kwargs['email'] != user.email:
        existing_user = User.query.filter_by(email=kwargs['email']).first()
        if existing_user:
            raise ValueError("Email already exists")
    
    # تحديث كلمة المرور إذا تم توفيرها
    if 'password' in kwargs:
        user.set_password(kwargs.pop('password'))
    
    # تحديث باقي البيانات
    for key, value in kwargs.items():
        if hasattr(user, key):
            setattr(user, key, value)
    
    user.updated_at = datetime.utcnow()
    db.session.commit()
    
    return user

def create_role(name, description, permissions=None):
    """إنشاء دور جديد"""
    # التحقق من عدم وجود دور بنفس الاسم
    existing_role = Role.query.filter_by(name=name).first()
    if existing_role:
        raise ValueError("Role already exists")
    
    # إنشاء الدور الجديد
    role = Role(
        name=name,
        description=description
    )
    
    db.session.add(role)
    
    # إضافة الصلاحيات إذا تم توفيرها
    if permissions:
        for permission_id in permissions:
            permission = Permission.query.get(permission_id)
            if permission:
                role.permissions.append(permission)
    
    db.session.commit()
    
    return role
```

### 3. إدارة تخصيص واجهة المستخدم

```python
def get_or_create_ui_settings(user_id):
    """الحصول على إعدادات واجهة المستخدم أو إنشائها إذا لم تكن موجودة"""
    ui_settings = UISettings.query.filter_by(user_id=user_id).first()
    
    if not ui_settings:
        ui_settings = UISettings(user_id=user_id)
        db.session.add(ui_settings)
        db.session.commit()
    
    return ui_settings

def update_ui_settings(user_id, **kwargs):
    """تحديث إعدادات واجهة المستخدم"""
    ui_settings = get_or_create_ui_settings(user_id)
    
    for key, value in kwargs.items():
        if hasattr(ui_settings, key):
            setattr(ui_settings, key, value)
    
    ui_settings.updated_at = datetime.utcnow()
    db.session.commit()
    
    return ui_settings

def update_dashboard_widgets(user_id, widgets):
    """تحديث ترتيب وتكوين الويدجت في لوحة المعلومات"""
    ui_settings = get_or_create_ui_settings(user_id)
    
    # تحويل قائمة الويدجت إلى سلسلة JSON
    widgets_json = json.dumps(widgets)
    
    ui_settings.dashboard_widgets = widgets_json
    ui_settings.updated_at = datetime.utcnow()
    db.session.commit()
    
    return ui_settings
```

## 📱 تجربة المستخدم

- واجهة مستخدم سهلة الاستخدام لإدارة الإعدادات
- تخصيص واجهة المستخدم وفقًا لتفضيلات المستخدم
- إمكانية تغيير السمة والألوان
- إمكانية تخصيص لوحة المعلومات

## 🔒 الأمان والصلاحيات

- تشفير كلمات المرور
- تحديد الأدوار والصلاحيات
- تسجيل جميع العمليات
- التحقق من الصلاحيات قبل تنفيذ العمليات

## 🚀 ميزات متقدمة


 تخصيص التقارير
- إنشاء تقارير مخصصة
- تخصيص التقارير الموجودة

## 💡 أفضل الممارسات

- مراجعة الإعدادات بانتظام
- تحديث كلمات المرور بشكل دوري
- مراجعة الأدوار والصلاحيات
- إجراء نسخ احتياطي منتظم للبيانات
- توثيق التغييرات في الإعدادات
- تدريب المستخدمين على استخدام النظام