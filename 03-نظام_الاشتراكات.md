# نظام الاشتراكات

## 🎯 نظرة عامة

نظام الاشتراكات هو الجسر الذي يربط بين الأعضاء وخطط العضوية، حيث يتيح إنشاء وإدارة اشتراكات الأعضاء في النادي الرياضي. يتعامل هذا النظام مع دورة حياة الاشتراك بالكامل، بدءًا من إنشاء الاشتراك، مرورًا بتتبع حالته، وانتهاءً بتجديده أو إنهائه.

## 📋 الوظائف الرئيسية

### 1. إدارة الاشتراكات
- إنشاء اشتراك جديد لعضو
- تعديل بيانات الاشتراك
- تجديد الاشتراك
- إلغاء أو تجميد الاشتراك
- متابعة حالة الاشتراك (نشط، منتهي، مجمد)

### 2. حساب تواريخ الاشتراك
- حساب تاريخ بداية الاشتراك
- حساب تاريخ انتهاء الاشتراك بناءً على خطة العضوية
- تمديد الاشتراك (إضافة أيام إضافية)
- تعويض الأيام الفائتة (في حالة إغلاق النادي مثلاً)

### 3. إدارة الحصص
- تتبع عدد الحصص المستخدمة
- حساب عدد الحصص المتبقية
- إضافة حصص إضافية
- تعويض الحصص الفائتة

### 4. إدارة المدفوعات
- ربط الاشتراك بالمدفوعات
- متابعة حالة الدفع (مدفوع بالكامل، مدفوع جزئيًا، غير مدفوع)
- حساب المبلغ المتبقي
- إنشاء فواتير للاشتراكات

## 🗃️ نموذج بيانات الاشتراك

```python
class Subscription(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    member_id = db.Column(db.Integer, db.ForeignKey('member.id'), nullable=False)
    plan_id = db.Column(db.Integer, db.ForeignKey('membership_plan.id'), nullable=False)
    start_date = db.Column(db.Date, nullable=False)
    end_date = db.Column(db.Date, nullable=False)
    status = db.Column(db.String(20), default='active')  # active, expired, frozen, cancelled
    total_sessions = db.Column(db.Integer, nullable=True)  # Null means unlimited
    remaining_sessions = db.Column(db.Integer, nullable=True)  # Null means unlimited
    price = db.Column(db.Float, nullable=False)
    discount = db.Column(db.Float, default=0)
    final_price = db.Column(db.Float, nullable=False)
    paid_amount = db.Column(db.Float, default=0)
    payment_status = db.Column(db.String(20), default='unpaid')  # unpaid, partially_paid, fully_paid
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    notes = db.Column(db.Text)
    frozen_days = db.Column(db.Integer, default=0)
    
    # العلاقات
    invoices = db.relationship('Invoice', backref='subscription', lazy=True)
    attendances = db.relationship('Attendance', backref='subscription', lazy=True)
```

## 🔄 العلاقات مع الأنظمة الأخرى

### 1. العلاقة مع نظام الأعضاء
- كل اشتراك ينتمي لعضو واحد
- يمكن للعضو أن يكون له عدة اشتراكات (تاريخية)
- يمكن أن يكون للعضو اشتراك نشط واحد فقط في وقت معين

### 2. العلاقة مع نظام خطط العضوية
- كل اشتراك يرتبط بخطة عضوية واحدة
- تحدد خطة العضوية خصائص الاشتراك (المدة، السعر، عدد الحصص)

### 3. العلاقة مع نظام الحضور
- كل تسجيل حضور يرتبط باشتراك نشط
- يتم خصم حصة من الاشتراك عند تسجيل الحضور (إذا كان الاشتراك محدود الحصص)

### 4. العلاقة مع نظام المدفوعات والفواتير
- كل اشتراك يمكن أن يكون له عدة فواتير ومدفوعات
- يتم تحديث حالة دفع الاشتراك بناءً على المدفوعات

## 📊 الإحصائيات والتقارير

### 1. إحصائيات الاشتراكات
- عدد الاشتراكات النشطة
- عدد الاشتراكات المنتهية
- عدد الاشتراكات المجمدة
- إجمالي إيرادات الاشتراكات

### 2. تقارير الاشتراكات
- تقرير الاشتراكات النشطة
- تقرير الاشتراكات المنتهية
- تقرير الاشتراكات التي ستنتهي قريبًا
- تقرير المدفوعات المتأخرة

## 🖥️ واجهات المستخدم

### 1. صفحة قائمة الاشتراكات
- عرض قائمة الاشتراكات مع إمكانية التصفية والفرز
- خيارات للبحث عن الاشتراكات
- أزرار للإجراءات السريعة (تعديل، تجديد، تجميد، إلغاء)

### 2. صفحة إضافة/تعديل اشتراك
- نموذج لإدخال بيانات الاشتراك
- اختيار العضو وخطة العضوية
- تحديد تاريخ البداية والنهاية
- إدخال بيانات الدفع

### 3. صفحة تفاصيل الاشتراك
- عرض بيانات الاشتراك الكاملة
- عرض بيانات العضو وخطة العضوية
- عرض سجل الحضور المرتبط بالاشتراك
- عرض المدفوعات والفواتير المرتبطة بالاشتراك

### 4. صفحة تجديد الاشتراك
- عرض بيانات الاشتراك الحالي
- اختيار خطة العضوية للتجديد
- تحديد تاريخ البداية والنهاية
- إدخال بيانات الدفع

## 🛠️ الخدمات والوظائف المتقدمة

### 1. حساب تواريخ الاشتراك

```python
def calculate_subscription_dates(start_date, plan):
    """حساب تاريخ انتهاء الاشتراك بناءً على تاريخ البداية وخطة العضوية"""
    end_date = start_date + timedelta(days=plan.duration_days)
    return end_date

def extend_subscription(subscription, days):
    """تمديد الاشتراك بإضافة أيام إضافية"""
    subscription.end_date = subscription.end_date + timedelta(days=days)
    return subscription
```

### 2. إدارة حالة الاشتراك

```python
def check_subscription_status(subscription):
    """التحقق من حالة الاشتراك وتحديثها إذا لزم الأمر"""
    today = date.today()
    if subscription.status == 'active' and subscription.end_date < today:
        subscription.status = 'expired'
    return subscription.status

def freeze_subscription(subscription, days):
    """تجميد الاشتراك لفترة محددة"""
    subscription.status = 'frozen'
    subscription.frozen_days += days
    subscription.end_date = subscription.end_date + timedelta(days=days)
    return subscription
```

### 3. إدارة الحصص

```python
def update_remaining_sessions(subscription, used_sessions=1):
    """تحديث عدد الحصص المتبقية بعد تسجيل الحضور"""
    if subscription.remaining_sessions is not None:  # إذا كان الاشتراك محدود الحصص
        subscription.remaining_sessions -= used_sessions
        if subscription.remaining_sessions <= 0:
            subscription.remaining_sessions = 0
            # يمكن تغيير حالة الاشتراك إلى منتهي إذا نفدت الحصص
    return subscription

def add_extra_sessions(subscription, extra_sessions):
    """إضافة حصص إضافية للاشتراك"""
    if subscription.remaining_sessions is not None:  # إذا كان الاشتراك محدود الحصص
        subscription.remaining_sessions += extra_sessions
        subscription.total_sessions += extra_sessions
    return subscription
```

## 📱 تجربة المستخدم

- واجهة مستخدم سهلة الاستخدام
- عرض حالة الاشتراك بشكل واضح
- تنبيهات للاشتراكات التي ستنتهي قريبًا
- إجراءات سريعة للعمليات المتكررة

## 🔒 الأمان والصلاحيات

- تحديد صلاحيات إنشاء وتعديل الاشتراكات
- تسجيل التغييرات على الاشتراكات
- حماية بيانات الاشتراكات من التعديل غير المصرح به

## 🚀 ميزات متقدمة

### 1. التجديد التلقائي
- إمكانية تفعيل التجديد التلقائي للاشتراك
- إرسال تنبيهات قبل التجديد
- إمكانية إلغاء التجديد التلقائي

### 2. الخصومات والعروض
- تطبيق خصومات على الاشتراكات
- تقديم عروض خاصة للتجديد
- خصومات للدفع المقدم

### 3. الاشتراكات المجمعة
- إمكانية إنشاء اشتراكات لمجموعة من الأعضاء
- تطبيق خصومات للمجموعات
- إدارة الاشتراكات المجمعة

## 💡 أفضل الممارسات

- التحقق من حالة الاشتراكات بشكل دوري
- إرسال تنبيهات للاشتراكات التي ستنتهي قريبًا
- توفير خيارات متعددة للتجديد
- تسهيل عملية التجديد
- الاحتفاظ بسجل كامل لتاريخ الاشتراكات