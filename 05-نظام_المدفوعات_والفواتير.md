# نظام المدفوعات والفواتير

## 🎯 نظرة عامة

نظام المدفوعات والفواتير هو المسؤول عن إدارة جميع العمليات المالية في النادي الرياضي، بدءًا من تحصيل رسوم الاشتراكات، وإنشاء الفواتير، وتسجيل المدفوعات، وإدارة المديونيات، وصولاً إلى إنشاء التقارير المالية. يوفر هذا النظام رؤية شاملة للوضع المالي للنادي ويضمن دقة وشفافية جميع المعاملات المالية.

## 📋 الوظائف الرئيسية

### 1. إدارة الفواتير
- إنشاء فواتير للاشتراكات والخدمات
- طباعة الفواتير بتنسيق PDF
- إرسال الفواتير بالبريد الإلكتروني
- متابعة حالة الفواتير (مدفوعة، غير مدفوعة، مدفوعة جزئيًا)

### 2. تسجيل المدفوعات
- تسجيل المدفوعات النقدية
- تسجيل المدفوعات الإلكترونية
- ربط المدفوعات بالفواتير والاشتراكات
- إصدار إيصالات للمدفوعات

### 3. إدارة المديونيات
- متابعة المديونيات لكل عضو
- إرسال تنبيهات للمديونيات المتأخرة
- جدولة المديونيات
- تسجيل الدفعات الجزئية

### 4. إدارة المصروفات
- تسجيل مصروفات النادي
- تصنيف المصروفات
- متابعة الميزانية

## 🗃️ نماذج بيانات المدفوعات والفواتير

### نموذج الفاتورة

```python
class Invoice(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    invoice_number = db.Column(db.String(20), unique=True, nullable=False)
    member_id = db.Column(db.Integer, db.ForeignKey('member.id'), nullable=False)
    subscription_id = db.Column(db.Integer, db.ForeignKey('subscription.id'), nullable=True)
    invoice_date = db.Column(db.Date, default=date.today)
    due_date = db.Column(db.Date, nullable=True)
    total_amount = db.Column(db.Float, nullable=False)
    paid_amount = db.Column(db.Float, default=0)
    status = db.Column(db.String(20), default='unpaid')  # unpaid, partially_paid, paid
    notes = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=True)
    
    # العلاقات
    payments = db.relationship('Payment', backref='invoice', lazy=True)
    items = db.relationship('InvoiceItem', backref='invoice', lazy=True)
```

### نموذج عناصر الفاتورة

```python
class InvoiceItem(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    invoice_id = db.Column(db.Integer, db.ForeignKey('invoice.id'), nullable=False)
    description = db.Column(db.String(200), nullable=False)
    quantity = db.Column(db.Integer, default=1)
    unit_price = db.Column(db.Float, nullable=False)
    total_price = db.Column(db.Float, nullable=False)
    item_type = db.Column(db.String(20), default='subscription')  # subscription, service, product
    item_id = db.Column(db.Integer, nullable=True)  # معرف العنصر (اشتراك، خدمة، منتج)
```

### نموذج المدفوعات

```python
class Payment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    payment_number = db.Column(db.String(20), unique=True, nullable=False)
    member_id = db.Column(db.Integer, db.ForeignKey('member.id'), nullable=False)
    invoice_id = db.Column(db.Integer, db.ForeignKey('invoice.id'), nullable=True)
    payment_date = db.Column(db.DateTime, default=datetime.utcnow)
    amount = db.Column(db.Float, nullable=False)
    payment_method = db.Column(db.String(20), default='cash')  # cash, card, bank_transfer
    reference_number = db.Column(db.String(50), nullable=True)  # رقم مرجعي للدفع الإلكتروني
    notes = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=True)
    payment_type = db.Column(db.String(20), default='income')  # income, expense, refund
```

### نموذج المصروفات

```python
class Expense(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    expense_number = db.Column(db.String(20), unique=True, nullable=False)
    expense_date = db.Column(db.Date, default=date.today)
    amount = db.Column(db.Float, nullable=False)
    category = db.Column(db.String(50), nullable=False)  # rent, utilities, salaries, maintenance, etc.
    description = db.Column(db.Text, nullable=False)
    payment_method = db.Column(db.String(20), default='cash')  # cash, card, bank_transfer
    reference_number = db.Column(db.String(50), nullable=True)
    notes = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=True)
```

## 🔄 العلاقات مع الأنظمة الأخرى

### 1. العلاقة مع نظام الأعضاء
- كل فاتورة ومدفوعة ترتبط بعضو محدد
- يمكن للعضو أن يكون له عدة فواتير ومدفوعات
- يتم متابعة المديونيات لكل عضو

### 2. العلاقة مع نظام الاشتراكات
- كل فاتورة يمكن أن ترتبط باشتراك محدد
- يتم تحديث حالة دفع الاشتراك بناءً على المدفوعات
- يمكن إنشاء فواتير لتجديد الاشتراكات

### 3. العلاقة مع نظام التقارير
- توفير بيانات المدفوعات والفواتير للتقارير المالية
- إنشاء تقارير مفصلة عن الإيرادات والمصروفات
- تحليل البيانات المالية لاتخاذ قرارات إدارية

## 📊 الإحصائيات والتقارير

### 1. إحصائيات المدفوعات
- إجمالي الإيرادات
- إجمالي المصروفات
- صافي الربح
- معدل التحصيل

### 2. تقارير المدفوعات
- تقرير الإيرادات اليومي/الأسبوعي/الشهري/السنوي
- تقرير المصروفات حسب الفئة
- تقرير المديونيات
- تقرير الأرباح والخسائر

## 🖥️ واجهات المستخدم

### 1. صفحة إنشاء فاتورة
- نموذج لإدخال بيانات الفاتورة
- اختيار العضو والاشتراك
- إضافة عناصر الفاتورة
- حساب المجموع

### 2. صفحة تسجيل مدفوعات
- نموذج لإدخال بيانات المدفوعة
- اختيار العضو والفاتورة
- تحديد طريقة الدفع
- إصدار إيصال

### 3. صفحة إدارة المديونيات
- عرض قائمة المديونيات
- خيارات للتصفية والفرز
- إمكانية جدولة المديونيات
- إرسال تنبيهات

### 4. صفحة إدارة المصروفات
- نموذج لإدخال بيانات المصروفات
- تصنيف المصروفات
- متابعة الميزانية

## 🛠️ الخدمات والوظائف المتقدمة

### 1. إنشاء فاتورة

```python
def create_invoice(member, subscription=None, items=None, notes=None):
    """إنشاء فاتورة جديدة"""
    # توليد رقم فاتورة فريد
    invoice_number = generate_invoice_number()
    
    # إنشاء الفاتورة
    invoice = Invoice(
        invoice_number=invoice_number,
        member_id=member.id,
        subscription_id=subscription.id if subscription else None,
        invoice_date=date.today(),
        due_date=date.today() + timedelta(days=7),  # استحقاق بعد أسبوع
        total_amount=0,  # سيتم حسابه لاحقًا
        status='unpaid',
        notes=notes
    )
    
    # إضافة عناصر الفاتورة
    total_amount = 0
    if items:
        for item in items:
            invoice_item = InvoiceItem(
                invoice=invoice,
                description=item['description'],
                quantity=item['quantity'],
                unit_price=item['unit_price'],
                total_price=item['quantity'] * item['unit_price'],
                item_type=item['item_type'],
                item_id=item['item_id']
            )
            total_amount += invoice_item.total_price
    
    # تحديث إجمالي الفاتورة
    invoice.total_amount = total_amount
    
    # حفظ الفاتورة
    db.session.add(invoice)
    db.session.commit()
    
    return invoice
```

### 2. تسجيل مدفوعة

```python
def record_payment(member, amount, payment_method, invoice=None, reference_number=None, notes=None):
    """تسجيل مدفوعة جديدة"""
    # توليد رقم مدفوعة فريد
    payment_number = generate_payment_number()
    
    # إنشاء المدفوعة
    payment = Payment(
        payment_number=payment_number,
        member_id=member.id,
        invoice_id=invoice.id if invoice else None,
        payment_date=datetime.utcnow(),
        amount=amount,
        payment_method=payment_method,
        reference_number=reference_number,
        notes=notes,
        payment_type='income'
    )
    
    # تحديث حالة الفاتورة إذا كانت موجودة
    if invoice:
        invoice.paid_amount += amount
        if invoice.paid_amount >= invoice.total_amount:
            invoice.status = 'paid'
        else:
            invoice.status = 'partially_paid'
    
    # تحديث حالة دفع الاشتراك إذا كانت الفاتورة مرتبطة باشتراك
    if invoice and invoice.subscription_id:
        subscription = Subscription.query.get(invoice.subscription_id)
        subscription.paid_amount += amount
        if subscription.paid_amount >= subscription.final_price:
            subscription.payment_status = 'fully_paid'
        else:
            subscription.payment_status = 'partially_paid'
    
    # حفظ المدفوعة
    db.session.add(payment)
    db.session.commit()
    
    return payment
```

### 3. إنشاء فاتورة PDF

```python
def generate_invoice_pdf(invoice):
    """إنشاء فاتورة بتنسيق PDF"""
    # استخدام مكتبة لإنشاء ملف PDF
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import letter
    from reportlab.platypus import Table, TableStyle
    from reportlab.lib import colors
    
    # إنشاء ملف PDF
    filename = f"invoice_{invoice.invoice_number}.pdf"
    c = canvas.Canvas(filename, pagesize=letter)
    
    # إضافة معلومات النادي
    c.setFont("Helvetica-Bold", 16)
    c.drawString(30, 750, "اسم النادي الرياضي")
    c.setFont("Helvetica", 12)
    c.drawString(30, 735, "العنوان: شارع النادي، المدينة")
    c.drawString(30, 720, "الهاتف: 123456789")
    c.drawString(30, 705, "البريد الإلكتروني: info@gym.com")
    
    # إضافة معلومات الفاتورة
    c.setFont("Helvetica-Bold", 14)
    c.drawString(400, 750, f"فاتورة رقم: {invoice.invoice_number}")
    c.setFont("Helvetica", 12)
    c.drawString(400, 735, f"التاريخ: {invoice.invoice_date.strftime('%Y-%m-%d')}")
    c.drawString(400, 720, f"تاريخ الاستحقاق: {invoice.due_date.strftime('%Y-%m-%d')}")
    
    # إضافة معلومات العضو
    member = Member.query.get(invoice.member_id)
    c.setFont("Helvetica-Bold", 14)
    c.drawString(30, 670, "معلومات العضو:")
    c.setFont("Helvetica", 12)
    c.drawString(30, 655, f"الاسم: {member.first_name} {member.last_name}")
    c.drawString(30, 640, f"كود العضوية: {member.member_code}")
    c.drawString(30, 625, f"الهاتف: {member.phone}")
    
    # إضافة عناصر الفاتورة
    data = [["الوصف", "الكمية", "السعر", "الإجمالي"]]
    for item in invoice.items:
        data.append([item.description, item.quantity, item.unit_price, item.total_price])
    
    # إضافة المجموع
    data.append(["المجموع", "", "", invoice.total_amount])
    
    # إنشاء جدول
    table = Table(data, colWidths=[250, 70, 100, 100])
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black)
    ]))
    
    # رسم الجدول
    table.wrapOn(c, 30, 400)
    table.drawOn(c, 30, 400)
    
    # إضافة ملاحظات
    c.setFont("Helvetica-Bold", 12)
    c.drawString(30, 300, "ملاحظات:")
    c.setFont("Helvetica", 10)
    c.drawString(30, 285, invoice.notes or "")
    
    # إضافة معلومات الدفع
    c.setFont("Helvetica-Bold", 12)
    c.drawString(30, 250, "معلومات الدفع:")
    c.setFont("Helvetica", 10)
    c.drawString(30, 235, "طرق الدفع المتاحة: نقدًا، بطاقة ائتمان، تحويل بنكي")
    
    # حفظ الملف
    c.save()
    
    return filename
```

## 📱 تجربة المستخدم

- واجهة مستخدم سهلة الاستخدام
- عملية إنشاء الفواتير وتسجيل المدفوعات سريعة وسلسة
- عرض رسائل واضحة للتأكيد أو الخطأ
- عرض معلومات الفواتير والمدفوعات بشكل واضح

## 🔒 الأمان والصلاحيات

- تحديد صلاحيات إنشاء الفواتير وتسجيل المدفوعات
- تسجيل المستخدم الذي قام بإنشاء الفاتورة أو تسجيل المدفوعة
- حماية البيانات المالية من التعديل غير المصرح به
- تسجيل جميع العمليات المالية


### 1. الدفع الإلكتروني
- دعم بوابات الدفع الإلكتروني
- دعم الدفع بالبطاقات الائتمانية
- دعم المحافظ الإلكترونية

### 2. الفواتير الإلكترونية
- إرسال الفواتير بالبريد الإلكتروني
- إمكانية الدفع عبر رابط في الفاتورة
- متابعة حالة الفاتورة

### 3. التقارير المالية المتقدمة
- تقارير الأرباح والخسائر
- تقارير التدفق النقدي
- تقارير الميزانية
- تحليل الإيرادات والمصروفات

## 💡 أفضل الممارسات

- توثيق جميع العمليات المالية
- إصدار فواتير وإيصالات لجميع المدفوعات
- متابعة المديونيات بشكل منتظم
- إرسال تنبيهات للمديونيات المتأخرة
- إنشاء نسخ احتياطية منتظمة للبيانات المالية
- مراجعة التقارير المالية بشكل دوري