# نظام المخزون والمبيعات

## 🎯 نظرة عامة

نظام المخزون والمبيعات هو المسؤول عن إدارة المنتجات والخدمات التي يقدمها النادي الرياضي للأعضاء والزوار. يتيح هذا النظام للنادي تتبع المخزون، وإدارة المبيعات، وتسجيل الإيرادات من بيع المنتجات والخدمات المختلفة مثل المكملات الغذائية، والملابس الرياضية، والمشروبات، والوجبات الصحية، وغيرها.

## 📋 الوظائف الرئيسية

### 1. إدارة المنتجات
- إضافة منتجات جديدة
- تعديل بيانات المنتجات
- تصنيف المنتجات
- تحديد أسعار البيع والتكلفة
- تحديد الحد الأدنى للمخزون

### 2. إدارة المخزون
- تسجيل عمليات استلام المنتجات
- تتبع مستويات المخزون
- تنبيهات انخفاض المخزون
- جرد المخزون
- تسجيل المنتجات التالفة أو المفقودة

### 3. إدارة المبيعات
- تسجيل عمليات البيع
- إصدار فواتير المبيعات
- تطبيق الخصومات
- ربط المبيعات بالأعضاء
- تسجيل طرق الدفع

### 4. إدارة الخدمات
- إضافة خدمات جديدة
- تعديل بيانات الخدمات
- تصنيف الخدمات
- تحديد أسعار الخدمات

## 🗃️ نماذج البيانات

### نموذج المنتج (Product)

```python
class Product(db.Model):
    __tablename__ = 'products'
    
    id = db.Column(db.Integer, primary_key=True)
    code = db.Column(db.String(20), unique=True, nullable=False)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.Text)
    category = db.Column(db.String(50))
    cost_price = db.Column(db.Float, nullable=False)
    selling_price = db.Column(db.Float, nullable=False)
    quantity = db.Column(db.Integer, default=0)
    min_quantity = db.Column(db.Integer, default=5)
    image_path = db.Column(db.String(255))
    active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # العلاقات
    inventory_transactions = db.relationship('InventoryTransaction', backref='product', lazy=True)
    sale_items = db.relationship('SaleItem', backref='product', lazy=True)
    
    def __repr__(self):
        return f'<Product {self.name}>'
    
    def get_profit_margin(self):
        """حساب هامش الربح"""
        if self.cost_price > 0:
            return ((self.selling_price - self.cost_price) / self.cost_price) * 100
        return 0
    
    def is_low_stock(self):
        """التحقق من انخفاض المخزون"""
        return self.quantity <= self.min_quantity
    
    def update_quantity(self, quantity_change, transaction_type):
        """تحديث كمية المخزون"""
        if transaction_type == 'in':
            self.quantity += quantity_change
        elif transaction_type == 'out':
            if self.quantity >= quantity_change:
                self.quantity -= quantity_change
            else:
                raise ValueError("Insufficient stock")
        
        # إنشاء سجل معاملة المخزون
        transaction = InventoryTransaction(
            product_id=self.id,
            transaction_type=transaction_type,
            quantity=quantity_change,
            notes=f"{'Stock In' if transaction_type == 'in' else 'Stock Out'}"
        )
        db.session.add(transaction)
        db.session.commit()
```

### نموذج معاملة المخزون (InventoryTransaction)

```python
class InventoryTransaction(db.Model):
    __tablename__ = 'inventory_transactions'
    
    id = db.Column(db.Integer, primary_key=True)
    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False)
    transaction_type = db.Column(db.String(10), nullable=False)  # 'in' or 'out'
    quantity = db.Column(db.Integer, nullable=False)
    transaction_date = db.Column(db.DateTime, default=datetime.utcnow)
    reference = db.Column(db.String(50))  # رقم الفاتورة أو أمر الشراء
    notes = db.Column(db.Text)
    
    def __repr__(self):
        return f'<InventoryTransaction {self.id} - {self.transaction_type}>'    
```

### نموذج المبيعات (Sale)

```python
class Sale(db.Model):
    __tablename__ = 'sales'
    
    id = db.Column(db.Integer, primary_key=True)
    sale_number = db.Column(db.String(20), unique=True, nullable=False)
    member_id = db.Column(db.Integer, db.ForeignKey('members.id'), nullable=True)  # يمكن أن تكون المبيعات لغير الأعضاء
    total_amount = db.Column(db.Float, nullable=False)
    discount = db.Column(db.Float, default=0)
    final_amount = db.Column(db.Float, nullable=False)
    payment_method = db.Column(db.String(20), nullable=False)  # cash, card, etc.
    sale_date = db.Column(db.DateTime, default=datetime.utcnow)
    notes = db.Column(db.Text)
    created_by = db.Column(db.Integer, db.ForeignKey('users.id'))
    
    # العلاقات
    items = db.relationship('SaleItem', backref='sale', lazy=True)
    member = db.relationship('Member', backref='sales', lazy=True)
    
    def __repr__(self):
        return f'<Sale {self.sale_number}>'
    
    def calculate_total(self):
        """حساب إجمالي المبيعات"""
        total = sum(item.subtotal for item in self.items)
        self.total_amount = total
        self.final_amount = total - self.discount
        return self.final_amount
```

### نموذج عنصر المبيعات (SaleItem)

```python
class SaleItem(db.Model):
    __tablename__ = 'sale_items'
    
    id = db.Column(db.Integer, primary_key=True)
    sale_id = db.Column(db.Integer, db.ForeignKey('sales.id'), nullable=False)
    product_id = db.Column(db.Integer, db.ForeignKey('products.id'), nullable=False)
    quantity = db.Column(db.Integer, nullable=False)
    unit_price = db.Column(db.Float, nullable=False)
    subtotal = db.Column(db.Float, nullable=False)
    
    def __repr__(self):
        return f'<SaleItem {self.id}>'
    
    def calculate_subtotal(self):
        """حساب المجموع الفرعي"""
        self.subtotal = self.quantity * self.unit_price
        return self.subtotal
```

### نموذج الخدمة (Service)

```python
class Service(db.Model):
    __tablename__ = 'services'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.Text)
    category = db.Column(db.String(50))
    price = db.Column(db.Float, nullable=False)
    duration_minutes = db.Column(db.Integer)  # مدة الخدمة بالدقائق
    active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # العلاقات
    service_bookings = db.relationship('ServiceBooking', backref='service', lazy=True)
    
    def __repr__(self):
        return f'<Service {self.name}>'
```

### نموذج حجز الخدمة (ServiceBooking)

```python
class ServiceBooking(db.Model):
    __tablename__ = 'service_bookings'
    
    id = db.Column(db.Integer, primary_key=True)
    service_id = db.Column(db.Integer, db.ForeignKey('services.id'), nullable=False)
    member_id = db.Column(db.Integer, db.ForeignKey('members.id'), nullable=False)
    booking_date = db.Column(db.Date, nullable=False)
    start_time = db.Column(db.Time, nullable=False)
    end_time = db.Column(db.Time, nullable=False)
    status = db.Column(db.String(20), default='booked')  # booked, completed, cancelled
    payment_status = db.Column(db.String(20), default='pending')  # pending, paid
    notes = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # العلاقات
    member = db.relationship('Member', backref='service_bookings', lazy=True)
    
    def __repr__(self):
        return f'<ServiceBooking {self.id}>'
```

## 🔄 العلاقات مع الأنظمة الأخرى

### 1. العلاقة مع نظام الأعضاء
- ربط المبيعات بالأعضاء
- تقديم خصومات خاصة للأعضاء
- تتبع مشتريات الأعضاء

### 2. العلاقة مع نظام المدفوعات والفواتير
- إنشاء فواتير للمبيعات
- تسجيل المدفوعات
- تتبع الإيرادات من المبيعات

### 3. العلاقة مع نظام التقارير
- توفير بيانات المبيعات للتقارير
- توفير بيانات المخزون للتقارير
- تحليل أداء المبيعات

## 📊 الإحصائيات والتقارير

### 1. تقارير المبيعات
- المبيعات اليومية/الأسبوعية/الشهرية/السنوية
- المبيعات حسب الفئة
- المبيعات حسب المنتج
- المبيعات حسب العضو

### 2. تقارير المخزون
- مستويات المخزون الحالية
- المنتجات منخفضة المخزون
- حركة المخزون
- قيمة المخزون

### 3. تقارير الربحية
- هوامش الربح
- المنتجات الأكثر ربحية
- تحليل التكلفة والإيرادات

## 🖥️ واجهات المستخدم

### 1. صفحة المنتجات
- قائمة بجميع المنتجات
- تفاصيل كل منتج
- إضافة/تعديل/حذف المنتجات

### 2. صفحة المخزون
- عرض مستويات المخزون
- إضافة/سحب من المخزون
- جرد المخزون

### 3. صفحة المبيعات
- إنشاء عملية بيع جديدة
- عرض سجل المبيعات
- تفاصيل كل عملية بيع

### 4. صفحة الخدمات
- قائمة بجميع الخدمات
- تفاصيل كل خدمة
- إضافة/تعديل/حذف الخدمات

## 🛠️ الخدمات والوظائف المتقدمة

### 1. إدارة المنتجات

```python
def add_product(name, description, category, cost_price, selling_price, quantity, min_quantity, image_path=None):
    """إضافة منتج جديد"""
    # إنشاء كود فريد للمنتج
    code = generate_product_code(category)
    
    product = Product(
        code=code,
        name=name,
        description=description,
        category=category,
        cost_price=cost_price,
        selling_price=selling_price,
        quantity=quantity,
        min_quantity=min_quantity,
        image_path=image_path
    )
    
    db.session.add(product)
    db.session.commit()
    
    # إنشاء معاملة مخزون أولية
    if quantity > 0:
        transaction = InventoryTransaction(
            product_id=product.id,
            transaction_type='in',
            quantity=quantity,
            notes="Initial stock"
        )
        db.session.add(transaction)
        db.session.commit()
    
    return product

def update_product(product_id, **kwargs):
    """تحديث بيانات المنتج"""
    product = Product.query.get(product_id)
    if not product:
        raise ValueError("Product not found")
    
    for key, value in kwargs.items():
        if hasattr(product, key):
            setattr(product, key, value)
    
    product.updated_at = datetime.utcnow()
    db.session.commit()
    
    return product

def generate_product_code(category):
    """توليد كود فريد للمنتج"""
    category_prefix = category[:2].upper()
    current_date = datetime.now().strftime("%y%m")
    
    # البحث عن آخر كود منتج بنفس الفئة والشهر
    last_product = Product.query.filter(
        Product.code.like(f"{category_prefix}{current_date}%")
    ).order_by(Product.code.desc()).first()
    
    if last_product:
        # استخراج الرقم التسلسلي من آخر كود
        last_sequence = int(last_product.code[-3:])
        new_sequence = last_sequence + 1
    else:
        new_sequence = 1
    
    # إنشاء الكود الجديد
    new_code = f"{category_prefix}{current_date}{new_sequence:03d}"
    
    return new_code
```

### 2. إدارة المخزون

```python
def add_stock(product_id, quantity, reference=None, notes=None):
    """إضافة مخزون للمنتج"""
    product = Product.query.get(product_id)
    if not product:
        raise ValueError("Product not found")
    
    # تحديث كمية المنتج
    product.update_quantity(quantity, 'in')
    
    return product

def remove_stock(product_id, quantity, reference=None, notes=None):
    """سحب مخزون من المنتج"""
    product = Product.query.get(product_id)
    if not product:
        raise ValueError("Product not found")
    
    if product.quantity < quantity:
        raise ValueError("Insufficient stock")
    
    # تحديث كمية المنتج
    product.update_quantity(quantity, 'out')
    
    return product

def get_low_stock_products():
    """الحصول على المنتجات منخفضة المخزون"""
    low_stock_products = []
    products = Product.query.filter(Product.active == True).all()
    
    for product in products:
        if product.is_low_stock():
            low_stock_products.append(product)
    
    return low_stock_products
```

### 3. إدارة المبيعات

```python
def create_sale(member_id, items, payment_method, discount=0, notes=None):
    """إنشاء عملية بيع جديدة"""
    # إنشاء رقم فريد للمبيعات
    sale_number = generate_sale_number()
    
    # إنشاء سجل المبيعات
    sale = Sale(
        sale_number=sale_number,
        member_id=member_id,
        total_amount=0,  # سيتم حسابها لاحقًا
        discount=discount,
        final_amount=0,  # سيتم حسابها لاحقًا
        payment_method=payment_method,
        notes=notes,
        created_by=current_user.id
    )
    
    db.session.add(sale)
    db.session.flush()  # للحصول على معرف المبيعات
    
    # إضافة عناصر المبيعات
    for item in items:
        product_id = item['product_id']
        quantity = item['quantity']
        
        # التحقق من توفر المخزون
        product = Product.query.get(product_id)
        if not product:
            db.session.rollback()
            raise ValueError(f"Product with ID {product_id} not found")
        
        if product.quantity < quantity:
            db.session.rollback()
            raise ValueError(f"Insufficient stock for product {product.name}")
        
        # إنشاء عنصر المبيعات
        sale_item = SaleItem(
            sale_id=sale.id,
            product_id=product_id,
            quantity=quantity,
            unit_price=product.selling_price,
            subtotal=product.selling_price * quantity
        )
        
        db.session.add(sale_item)
        
        # تحديث المخزون
        product.update_quantity(quantity, 'out')
    
    # حساب إجمالي المبيعات
    sale.calculate_total()
    
    # إنشاء فاتورة للمبيعات
    invoice = create_invoice_for_sale(sale)
    
    db.session.commit()
    
    return sale

def generate_sale_number():
    """توليد رقم فريد للمبيعات"""
    current_date = datetime.now().strftime("%Y%m%d")
    
    # البحث عن آخر رقم مبيعات لنفس اليوم
    last_sale = Sale.query.filter(
        Sale.sale_number.like(f"S{current_date}%")
    ).order_by(Sale.sale_number.desc()).first()
    
    if last_sale:
        # استخراج الرقم التسلسلي من آخر رقم مبيعات
        last_sequence = int(last_sale.sale_number[-4:])
        new_sequence = last_sequence + 1
    else:
        new_sequence = 1
    
    # إنشاء الرقم الجديد
    new_number = f"S{current_date}{new_sequence:04d}"
    
    return new_number
```

## 📱 تجربة المستخدم

- واجهة مستخدم سهلة الاستخدام
- عملية بيع سريعة وسلسة
- إمكانية البحث عن المنتجات بسهولة
- عرض صور المنتجات
- تنبيهات للمخزون المنخفض

## 🔒 الأمان والصلاحيات

- تحديد صلاحيات الوصول إلى المخزون
- تحديد صلاحيات إجراء عمليات البيع
- تسجيل جميع العمليات مع تحديد المستخدم
- حماية بيانات المبيعات والمخزون

## 🚀 ميزات متقدمة

### 1. الباركود والماسح الضوئي
- دعم الباركود للمنتجات
- إمكانية استخدام الماسح الضوئي في عمليات البيع والجرد
- طباعة ملصقات الباركود

### 2. نقاط البيع (POS)
- نظام نقاط بيع متكامل
- دعم الطابعات الحرارية
- دعم أدراج النقود
- دعم شاشات العرض للعملاء

### 3. إدارة الموردين
- تسجيل بيانات الموردين
- ربط المنتجات بالموردين
- تتبع أوامر الشراء
- تقييم أداء الموردين


## 💡 أفضل الممارسات

- إجراء جرد دوري للمخزون
- مراقبة مستويات المخزون بانتظام
- تحليل بيانات المبيعات لتحسين العروض
- تدريب الموظفين على استخدام النظام
- تحديث أسعار المنتجات بانتظام
- مراقبة تواريخ انتهاء صلاحية المنتجات
- تقديم عروض وخصومات للمنتجات بطيئة الحركة