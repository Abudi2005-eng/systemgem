# نظام التقارير

## 🎯 نظرة عامة

نظام التقارير هو المسؤول عن توفير رؤية شاملة لأداء النادي الرياضي من خلال تجميع وتحليل وعرض البيانات من مختلف أنظمة النادي. يوفر هذا النظام تقارير متنوعة تساعد الإدارة في اتخاذ القرارات المستنيرة، ومتابعة أداء النادي، وتحديد فرص التحسين.

## 📋 الوظائف الرئيسية

### 1. التقارير المالية
- تقارير الإيرادات (يومية، أسبوعية، شهرية، سنوية)
- تقارير المصروفات حسب الفئة
- تقارير الأرباح والخسائر
- تقارير المديونيات
- تقارير التدفق النقدي

### 2. تقارير الأعضاء
- تقارير الأعضاء النشطين
- تقارير الأعضاء الجدد
- تقارير الأعضاء المنتهية اشتراكاتهم
- تقارير الأعضاء حسب الفئة العمرية والجنس
- تقارير معدل الاحتفاظ بالأعضاء

### 3. تقارير الاشتراكات
- تقارير الاشتراكات النشطة
- تقارير الاشتراكات حسب نوع الخطة
- تقارير الاشتراكات التي ستنتهي قريبًا
- تقارير تجديد الاشتراكات

### 4. تقارير الحضور
- تقارير الحضور اليومي
- تقارير أوقات الذروة
- تقارير معدل الحضور
- تقارير الحضور حسب الفترة (صباحي/مسائي)

## 🗃️ نماذج بيانات التقارير

### نموذج تقرير مالي

```python
class FinancialReport:
    def __init__(self, start_date, end_date, report_type='daily'):
        self.start_date = start_date
        self.end_date = end_date
        self.report_type = report_type  # daily, weekly, monthly, yearly
        self.total_income = 0
        self.total_expenses = 0
        self.net_profit = 0
        self.income_by_category = {}
        self.expenses_by_category = {}
        self.outstanding_payments = 0
        self.data = []
    
    def generate(self):
        """توليد التقرير المالي"""
        # حساب الإيرادات
        payments = Payment.query.filter(
            Payment.payment_date >= self.start_date,
            Payment.payment_date <= self.end_date,
            Payment.payment_type == 'income'
        ).all()
        
        for payment in payments:
            self.total_income += payment.amount
            category = 'subscription' if payment.invoice and payment.invoice.subscription_id else 'other'
            if category not in self.income_by_category:
                self.income_by_category[category] = 0
            self.income_by_category[category] += payment.amount
        
        # حساب المصروفات
        expenses = Payment.query.filter(
            Payment.payment_date >= self.start_date,
            Payment.payment_date <= self.end_date,
            Payment.payment_type == 'expense'
        ).all()
        
        for expense in expenses:
            self.total_expenses += expense.amount
            category = expense.notes or 'other'
            if category not in self.expenses_by_category:
                self.expenses_by_category[category] = 0
            self.expenses_by_category[category] += expense.amount
        
        # حساب صافي الربح
        self.net_profit = self.total_income - self.total_expenses
        
        # حساب المديونيات
        invoices = Invoice.query.filter(
            Invoice.invoice_date >= self.start_date,
            Invoice.invoice_date <= self.end_date,
            Invoice.status.in_(['unpaid', 'partially_paid'])
        ).all()
        
        for invoice in invoices:
            self.outstanding_payments += (invoice.total_amount - invoice.paid_amount)
        
        # تجميع البيانات حسب نوع التقرير
        if self.report_type == 'daily':
            self._group_by_day()
        elif self.report_type == 'weekly':
            self._group_by_week()
        elif self.report_type == 'monthly':
            self._group_by_month()
        elif self.report_type == 'yearly':
            self._group_by_year()
        
        return self
    
    def _group_by_day(self):
        """تجميع البيانات حسب اليوم"""
        current_date = self.start_date
        while current_date <= self.end_date:
            income = sum([p.amount for p in Payment.query.filter(
                func.date(Payment.payment_date) == current_date,
                Payment.payment_type == 'income'
            ).all()])
            
            expenses = sum([p.amount for p in Payment.query.filter(
                func.date(Payment.payment_date) == current_date,
                Payment.payment_type == 'expense'
            ).all()])
            
            self.data.append({
                'date': current_date.strftime('%Y-%m-%d'),
                'income': income,
                'expenses': expenses,
                'profit': income - expenses
            })
            
            current_date += timedelta(days=1)
```

### نموذج تقرير الأعضاء

```python
class MemberReport:
    def __init__(self, start_date=None, end_date=None, report_type='active'):
        self.start_date = start_date
        self.end_date = end_date or date.today()
        self.report_type = report_type  # active, new, expired, retention
        self.total_members = 0
        self.members_by_gender = {}
        self.members_by_age_group = {}
        self.data = []
    
    def generate(self):
        """توليد تقرير الأعضاء"""
        if self.report_type == 'active':
            self._active_members()
        elif self.report_type == 'new':
            self._new_members()
        elif self.report_type == 'expired':
            self._expired_members()
        elif self.report_type == 'retention':
            self._retention_rate()
        
        return self
    
    def _active_members(self):
        """تقرير الأعضاء النشطين"""
        members = Member.query.filter(Member.active == True).all()
        self.total_members = len(members)
        
        # تصنيف حسب الجنس
        for member in members:
            gender = member.gender or 'unknown'
            if gender not in self.members_by_gender:
                self.members_by_gender[gender] = 0
            self.members_by_gender[gender] += 1
            
            # تصنيف حسب الفئة العمرية
            if member.birth_date:
                age = (date.today() - member.birth_date).days // 365
                age_group = self._get_age_group(age)
                if age_group not in self.members_by_age_group:
                    self.members_by_age_group[age_group] = 0
                self.members_by_age_group[age_group] += 1
        
        self.data = members
    
    def _new_members(self):
        """تقرير الأعضاء الجدد"""
        members = Member.query.filter(
            Member.join_date >= self.start_date,
            Member.join_date <= self.end_date
        ).all()
        
        self.total_members = len(members)
        
        # تصنيف حسب الجنس والفئة العمرية
        for member in members:
            gender = member.gender or 'unknown'
            if gender not in self.members_by_gender:
                self.members_by_gender[gender] = 0
            self.members_by_gender[gender] += 1
            
            if member.birth_date:
                age = (date.today() - member.birth_date).days // 365
                age_group = self._get_age_group(age)
                if age_group not in self.members_by_age_group:
                    self.members_by_age_group[age_group] = 0
                self.members_by_age_group[age_group] += 1
        
        self.data = members
    
    def _get_age_group(self, age):
        """تحديد الفئة العمرية"""
        if age < 18:
            return '<18'
        elif age < 25:
            return '18-24'
        elif age < 35:
            return '25-34'
        elif age < 45:
            return '35-44'
        elif age < 55:
            return '45-54'
        else:
            return '55+'
```

## 🔄 العلاقات مع الأنظمة الأخرى

### 1. العلاقة مع نظام الأعضاء
- استخدام بيانات الأعضاء لإنشاء تقارير الأعضاء
- تحليل بيانات الأعضاء لفهم التركيبة السكانية للنادي

### 2. العلاقة مع نظام الاشتراكات
- استخدام بيانات الاشتراكات لإنشاء تقارير الاشتراكات
- تحليل بيانات الاشتراكات لفهم أنماط التجديد والإلغاء

### 3. العلاقة مع نظام المدفوعات والفواتير
- استخدام بيانات المدفوعات والفواتير لإنشاء التقارير المالية
- تحليل البيانات المالية لفهم الوضع المالي للنادي

### 4. العلاقة مع نظام الحضور
- استخدام بيانات الحضور لإنشاء تقارير الحضور
- تحليل بيانات الحضور لفهم أنماط استخدام النادي

## 📊 أنواع التقارير

### 1. التقارير الملخصة
- لوحة معلومات تعرض المؤشرات الرئيسية
- ملخص يومي/أسبوعي/شهري/سنوي
- مقارنة مع الفترات السابقة

### 2. التقارير التفصيلية
- تقارير مفصلة لكل نظام
- تقارير تفصيلية لكل فترة زمنية
- تقارير تفصيلية لكل فئة

### 3. التقارير التحليلية
- تحليل الاتجاهات
- تحليل الأنماط
- تحليل المؤشرات

### 4. التقارير المخصصة
- إمكانية إنشاء تقارير مخصصة
- اختيار المعايير والفلاتر
- اختيار طريقة العرض

## 🖥️ واجهات المستخدم

### 1. لوحة المعلومات
- عرض المؤشرات الرئيسية
- رسوم بيانية وإحصائيات
- تحديثات في الوقت الفعلي

### 2. صفحة التقارير
- قائمة بالتقارير المتاحة
- خيارات لتصفية وفرز التقارير
- إمكانية تصدير التقارير

### 3. صفحة إنشاء تقرير
- نموذج لاختيار نوع التقرير
- خيارات لتحديد الفترة الزمنية
- خيارات لتحديد المعايير والفلاتر

### 4. صفحة عرض التقرير
- عرض التقرير بتنسيق مناسب
- خيارات للطباعة والتصدير
- إمكانية حفظ التقرير

## 🛠️ الخدمات والوظائف المتقدمة

### 1. توليد التقارير

```python
def generate_financial_report(start_date, end_date, report_type='monthly'):
    """توليد تقرير مالي"""
    report = FinancialReport(start_date, end_date, report_type)
    return report.generate()

def generate_member_report(start_date=None, end_date=None, report_type='active'):
    """توليد تقرير الأعضاء"""
    report = MemberReport(start_date, end_date, report_type)
    return report.generate()

def generate_subscription_report(start_date=None, end_date=None, report_type='active'):
    """توليد تقرير الاشتراكات"""
    report = SubscriptionReport(start_date, end_date, report_type)
    return report.generate()

def generate_attendance_report(start_date=None, end_date=None, report_type='daily'):
    """توليد تقرير الحضور"""
    report = AttendanceReport(start_date, end_date, report_type)
    return report.generate()
```

### 2. تصدير التقارير

```python
def export_report_to_csv(report, filename):
    """تصدير التقرير إلى ملف CSV"""
    import csv
    
    with open(filename, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        
        # كتابة رأس الجدول
        if isinstance(report, FinancialReport):
            writer.writerow(['التاريخ', 'الإيرادات', 'المصروفات', 'الربح'])
            for item in report.data:
                writer.writerow([item['date'], item['income'], item['expenses'], item['profit']])
        
        elif isinstance(report, MemberReport):
            if report.report_type == 'active' or report.report_type == 'new' or report.report_type == 'expired':
                writer.writerow(['كود العضوية', 'الاسم', 'الهاتف', 'تاريخ الانضمام', 'الحالة'])
                for member in report.data:
                    writer.writerow([member.member_code, f"{member.first_name} {member.last_name}", member.phone, member.join_date.strftime('%Y-%m-%d'), 'نشط' if member.active else 'غير نشط'])
        
        # ... المزيد من أنواع التقارير
    
    return filename

def export_report_to_pdf(report, filename):
    """تصدير التقرير إلى ملف PDF"""
    # استخدام مكتبة لإنشاء ملف PDF
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import letter
    from reportlab.platypus import Table, TableStyle
    from reportlab.lib import colors
    
    # ... كود إنشاء ملف PDF
    
    return filename

def export_report_to_excel(report, filename):
    """تصدير التقرير إلى ملف Excel"""
    import pandas as pd
    
    # ... كود إنشاء ملف Excel
    
    return filename
```

### 3. جدولة التقارير

```python
def schedule_report(report_type, schedule_type, recipient_email):
    """جدولة إرسال التقرير بشكل دوري"""
    # إنشاء جدولة لإرسال التقرير
    schedule = ReportSchedule(
        report_type=report_type,  # financial, member, subscription, attendance
        schedule_type=schedule_type,  # daily, weekly, monthly
        recipient_email=recipient_email,
        active=True
    )
    
    db.session.add(schedule)
    db.session.commit()
    
    return schedule

def send_scheduled_reports():
    """إرسال التقارير المجدولة"""
    # الحصول على التقارير المجدولة التي يجب إرسالها اليوم
    today = date.today()
    schedules = ReportSchedule.query.filter(ReportSchedule.active == True).all()
    
    for schedule in schedules:
        # التحقق من موعد الإرسال
        if schedule.schedule_type == 'daily' or \
           (schedule.schedule_type == 'weekly' and today.weekday() == 0) or \
           (schedule.schedule_type == 'monthly' and today.day == 1):
            
            # توليد التقرير
            if schedule.report_type == 'financial':
                if schedule.schedule_type == 'daily':
                    start_date = today
                    end_date = today
                elif schedule.schedule_type == 'weekly':
                    start_date = today - timedelta(days=7)
                    end_date = today
                elif schedule.schedule_type == 'monthly':
                    start_date = today.replace(day=1) - timedelta(days=1)
                    start_date = start_date.replace(day=1)
                    end_date = today.replace(day=1) - timedelta(days=1)
                
                report = generate_financial_report(start_date, end_date, schedule.schedule_type)
            
            # ... المزيد من أنواع التقارير
            
            # تصدير التقرير
            filename = f"{schedule.report_type}_{today.strftime('%Y-%m-%d')}.csv"
            export_report_to_csv(report, filename)
            
            # إرسال التقرير بالبريد الإلكتروني
            send_report_email(schedule.recipient_email, filename, report)
```

## 📱 تجربة المستخدم

- واجهة مستخدم سهلة الاستخدام
- عرض التقارير بشكل واضح وجذاب
- إمكانية تصفية وفرز البيانات
- إمكانية تصدير التقارير بتنسيقات مختلفة

## 🔒 الأمان والصلاحيات

- تحديد صلاحيات الوصول إلى التقارير
- تحديد صلاحيات إنشاء وتصدير التقارير
- حماية البيانات الحساسة في التقارير
- تسجيل الوصول إلى التقارير

## 🚀 ميزات متقدمة

### 1. التقارير التفاعلية
- إمكانية التفاعل مع التقارير
- تصفية وفرز البيانات في الوقت الفعلي
- تغيير طريقة عرض البيانات

- إرسال تنبيهات عند تجاوز مؤشرات معينة
- إرسال تقارير دورية بالبريد الإلكتروني
- إرسال إشعارات للمستخدمين

- تحليل الاتجاهات والأنماط
- التنبؤ بالمؤشرات المستقبلية
- تحليل سلوك الأعضاء

## 💡 أفضل الممارسات

- تصميم تقارير واضحة وسهلة الفهم
- استخدام الرسوم البيانية والمخططات لتوضيح البيانات
- توفير خيارات للتصفية والفرز
- إمكانية تصدير التقارير بتنسيقات مختلفة
- جدولة التقارير الهامة لإرسالها بشكل دوري
- مراجعة وتحليل التقارير بشكل منتظم