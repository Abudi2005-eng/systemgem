# نظام الحضور والانصراف

## 🎯 نظرة عامة

نظام الحضور والانصراف هو المسؤول عن تتبع دخول وخروج الأعضاء من النادي الرياضي. يوفر هذا النظام آلية دقيقة لتسجيل وقت الحضور والانصراف، مع التحقق من صلاحية الاشتراك وعدد الحصص المتبقية، بالإضافة إلى توفير إحصائيات وتقارير مفصلة عن أنماط الحضور.

## 📋 الوظائف الرئيسية

### 1. تسجيل الحضور والانصراف
- تسجيل حضور العضو عند الدخول
- تسجيل انصراف العضو عند الخروج
- حساب مدة التمرين
- التحقق من صلاحية الاشتراك

### 2. التحقق من الصلاحية
- التحقق من وجود اشتراك نشط
- التحقق من عدم انتهاء الاشتراك
- التحقق من وجود حصص متبقية (إذا كان الاشتراك محدود الحصص)
- التحقق من الفترة المسموح بها (رجال/سيدات)

### 3. إدارة الحصص
- خصم حصة عند تسجيل الحضور (إذا كان الاشتراك محدود الحصص)
- عرض عدد الحصص المتبقية
- تنبيه عند اقتراب نفاد الحصص

### 4. متابعة الحضور
- عرض سجل الحضور لكل عضو
- عرض إحصائيات الحضور
- تحليل أنماط الحضور

## 🗃️ نموذج بيانات الحضور

```python
class Attendance(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    member_id = db.Column(db.Integer, db.ForeignKey('member.id'), nullable=False)
    subscription_id = db.Column(db.Integer, db.ForeignKey('subscription.id'), nullable=False)
    check_in_time = db.Column(db.DateTime, default=datetime.utcnow)
    check_out_time = db.Column(db.DateTime, nullable=True)
    duration_minutes = db.Column(db.Integer, nullable=True)
    notes = db.Column(db.Text)
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=True)
```

## 🔄 العلاقات مع الأنظمة الأخرى

### 1. العلاقة مع نظام الأعضاء
- كل تسجيل حضور ينتمي لعضو واحد
- يمكن للعضو أن يكون له عدة تسجيلات حضور
- يتم ربط تسجيل الحضور بالعضو من خلال معرف العضو

### 2. العلاقة مع نظام الاشتراكات
- كل تسجيل حضور يرتبط باشتراك نشط
- يتم التحقق من صلاحية الاشتراك عند تسجيل الحضور
- يتم خصم حصة من الاشتراك عند تسجيل الحضور (إذا كان الاشتراك محدود الحصص)

### 3. العلاقة مع نظام التقارير
- توفير بيانات الحضور للتقارير
- إنشاء تقارير مفصلة عن أنماط الحضور
- تحليل بيانات الحضور لاتخاذ قرارات إدارية

## 📊 الإحصائيات والتقارير

### 1. إحصائيات الحضور
- عدد مرات الحضور لكل عضو
- متوسط مدة التمرين
- أوقات الذروة في النادي
- معدل الحضور اليومي/الأسبوعي/الشهري

### 2. تقارير الحضور
- تقرير الحضور اليومي
- تقرير الحضور الأسبوعي
- تقرير الحضور الشهري
- تقرير الحضور حسب الفترة (صباحي/مسائي)

## 🖥️ واجهات المستخدم

### 1. صفحة تسجيل الحضور
- نموذج لإدخال كود العضو أو البحث عن العضو
- عرض بيانات العضو والاشتراك
- زر لتسجيل الحضور
- عرض رسالة تأكيد أو خطأ

### 2. صفحة تسجيل الانصراف
- عرض قائمة الأعضاء الموجودين حاليًا في النادي
- زر لتسجيل الانصراف
- عرض مدة التمرين

### 3. صفحة سجل الحضور
- عرض سجل الحضور مع إمكانية التصفية والفرز
- خيارات للبحث في سجل الحضور
- إمكانية تصدير سجل الحضور

### 4. لوحة معلومات الحضور
- عرض إحصائيات الحضور
- عرض أوقات الذروة
- عرض معدل الحضور

## 🛠️ الخدمات والوظائف المتقدمة

### 1. التحقق من صلاحية الاشتراك

```python
def can_check_in(member):
    """التحقق من إمكانية تسجيل الحضور للعضو"""
    # التحقق من وجود اشتراك نشط
    active_subscription = member.get_active_subscription()
    if not active_subscription:
        return False, "لا يوجد اشتراك نشط"
    
    # التحقق من عدم انتهاء الاشتراك
    if active_subscription.end_date < date.today():
        return False, "الاشتراك منتهي"
    
    # التحقق من وجود حصص متبقية
    if active_subscription.remaining_sessions is not None and active_subscription.remaining_sessions <= 0:
        return False, "لا توجد حصص متبقية"
    
    # التحقق من الفترة المسموح بها
    current_time = datetime.now().time()
    if active_subscription.plan.time_restriction == 'men':
        # التحقق من فترة الرجال
        pass
    elif active_subscription.plan.time_restriction == 'women':
        # التحقق من فترة السيدات
        pass
    
    return True, "يمكن تسجيل الحضور"
```

### 2. تسجيل الحضور

```python
def check_in(member):
    """تسجيل حضور العضو"""
    # التحقق من إمكانية تسجيل الحضور
    can_check, message = can_check_in(member)
    if not can_check:
        return False, message
    
    # الحصول على الاشتراك النشط
    active_subscription = member.get_active_subscription()
    
    # إنشاء سجل حضور جديد
    attendance = Attendance(
        member_id=member.id,
        subscription_id=active_subscription.id,
        check_in_time=datetime.utcnow()
    )
    
    # خصم حصة من الاشتراك إذا كان محدود الحصص
    if active_subscription.remaining_sessions is not None:
        active_subscription.remaining_sessions -= 1
    
    # حفظ التغييرات
    db.session.add(attendance)
    db.session.commit()
    
    return True, "تم تسجيل الحضور بنجاح", attendance
```

### 3. تسجيل الانصراف

```python
def check_out(attendance):
    """تسجيل انصراف العضو"""
    # التحقق من عدم تسجيل الانصراف مسبقًا
    if attendance.check_out_time is not None:
        return False, "تم تسجيل الانصراف مسبقًا"
    
    # تسجيل وقت الانصراف
    attendance.check_out_time = datetime.utcnow()
    
    # حساب مدة التمرين
    duration = attendance.check_out_time - attendance.check_in_time
    attendance.duration_minutes = int(duration.total_seconds() / 60)
    
    # حفظ التغييرات
    db.session.commit()
    
    return True, "تم تسجيل الانصراف بنجاح", attendance
```

## 📱 تجربة المستخدم

- واجهة مستخدم سهلة الاستخدام
- عملية تسجيل الحضور والانصراف سريعة وسلسة
- عرض رسائل واضحة للتأكيد أو الخطأ
- عرض معلومات العضو والاشتراك بشكل واضح

## 🔒 الأمان والصلاحيات

- تحديد صلاحيات تسجيل الحضور والانصراف
- تسجيل المستخدم الذي قام بتسجيل الحضور
- حماية بيانات الحضور من التعديل غير المصرح به
- تسجيل التغييرات على سجلات الحضور

## 🚀 ميزات متقدمة

### 1. تسجيل الحضور التلقائي
- استخدام بطاقات RFID لتسجيل الحضور
- استخدام تطبيق الهاتف لتسجيل الحضور
- استخدام بصمة الإصبع أو بصمة الوجه

### 2. تنبيهات الحضور
- إرسال تنبيه للعضو عند تسجيل الحضور
- إرسال تنبيه للعضو عند تسجيل الانصراف
- إرسال تنبيه عند اقتراب نفاد الحصص

### 3. تحليل أنماط الحضور
- تحليل أوقات الحضور المفضلة لكل عضو
- تحليل مدة التمرين لكل عضو
- تقديم توصيات بناءً على أنماط الحضور

## 💡 أفضل الممارسات

- تبسيط عملية تسجيل الحضور والانصراف
- التحقق من صلاحية الاشتراك قبل تسجيل الحضور
- عرض رسائل واضحة للتأكيد أو الخطأ
- الاحتفاظ بسجل كامل للحضور والانصراف
- استخدام التكنولوجيا لتسهيل عملية تسجيل الحضور